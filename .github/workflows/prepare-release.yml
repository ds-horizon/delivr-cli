name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      # Install all dependencies first
      - name: Install Dependencies
        run: |
          # System dependencies for bsdiff
          sudo apt-get update
          sudo apt-get install -y libbz2-dev
          
          # npm dependencies with exact lockfile
          npm ci

      # Handle version bump and create PR
      - name: Prepare Release
        id: release
        run: |
          # Setup git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Get current version before bump
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Create new branch with next version
          NEW_BRANCH="release/v$CURRENT_VERSION-next"
          git checkout -b $NEW_BRANCH
          
          # Bump version in package.json
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "New version: $NEW_VERSION"
          
          # Generate release notes
          echo "## What's Changed" > release_notes.md
          if git rev-parse --verify "v$CURRENT_VERSION" >/dev/null 2>&1; then
            git log --pretty=format:"* %s" v$CURRENT_VERSION..HEAD >> release_notes.md
            echo -e "\n\n## Full Changelog" >> release_notes.md
            echo "https://github.com/${{ github.repository }}/compare/v$CURRENT_VERSION...v$NEW_VERSION" >> release_notes.md
          else
            git log --pretty=format:"* %s" >> release_notes.md
            echo -e "\n\n## First Release" >> release_notes.md
            echo "First release of the package." >> release_notes.md
          fi
          
          # Update package-lock.json
          npm install --package-lock-only
          
          # Stage and commit all changes
          git add package.json package-lock.json release_notes.md
          git commit -m "chore: prepare release v$NEW_VERSION"
          
          # Push to new branch
          git push -f origin $NEW_BRANCH
          
          # Rename branch to final version
          git push origin -d $NEW_BRANCH || true
          FINAL_BRANCH="release/v$NEW_VERSION"
          git branch -m $NEW_BRANCH $FINAL_BRANCH
          git push -f origin $FINAL_BRANCH

      # Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'ðŸš€ Release v${{ env.NEW_VERSION }}'
          body: |
            ## Release v${{ env.NEW_VERSION }}
            
            $(cat release_notes.md)
            
            ---
            This PR was automatically generated by the release workflow.
          branch: release/v${{ env.NEW_VERSION }}
          base: main
          labels: release
          draft: false
